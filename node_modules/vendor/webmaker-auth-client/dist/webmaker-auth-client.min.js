/*!
 * EventEmitter v4.2.8 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

/**
   * To Title Case 2.1 - http://individed.com/code/to-title-case/
   * Copyright 2008-2013 David Gouch. Licensed under the MIT License.
   * https://github.com/gouch/to-title-case
   */

(function(){function e(){}function t(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function r(e){return function(){return this[e].apply(this,arguments)}}var n=e.prototype,s=this,a=s.EventEmitter;n.getListeners=function(e){var t,r,n=this._getEvents();if(e instanceof RegExp){t={};for(r in n)n.hasOwnProperty(r)&&e.test(r)&&(t[r]=n[r])}else t=n[e]||(n[e]=[]);return t},n.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},n.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&(t={},t[e]=r),t||r},n.addListener=function(e,r){var n,s=this.getListenersAsObject(e),a="object"==typeof r;for(n in s)s.hasOwnProperty(n)&&-1===t(s[n],r)&&s[n].push(a?r:{listener:r,once:!1});return this},n.on=r("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=r("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,r){var n,s,a=this.getListenersAsObject(e);for(s in a)a.hasOwnProperty(s)&&(n=t(a[s],r),-1!==n&&a[s].splice(n,1));return this},n.off=r("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,r){var n,s,a=e?this.removeListener:this.addListener,i=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(n=r.length;n--;)a.call(this,t,r[n]);else for(n in t)t.hasOwnProperty(n)&&(s=t[n])&&("function"==typeof s?a.call(this,n,s):i.call(this,n,s));return this},n.removeEvent=function(e){var t,r=typeof e,n=this._getEvents();if("string"===r)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},n.removeAllListeners=r("removeEvent"),n.emitEvent=function(e,t){var r,n,s,a,i=this.getListenersAsObject(e);for(s in i)if(i.hasOwnProperty(s))for(n=i[s].length;n--;)r=i[s][n],r.once===!0&&this.removeListener(e,r.listener),a=r.listener.apply(this,t||[]),a===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},n.trigger=r("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},n._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return s.EventEmitter=a,e},"function"==typeof define&&define.amd?define("eventEmitter/EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:this.EventEmitter=e}).call(this),function(){var e={serialize:function(e,r,n){n=n||{};var s=n.encode||t,a=[e+"="+s(r)];if(null!=n.maxAge){var i=n.maxAge-0;if(isNaN(i))throw new Error("maxAge should be a Number");a.push("Max-Age="+i)}return n.domain&&a.push("Domain="+n.domain),n.path&&a.push("Path="+n.path),n.expires&&a.push("Expires="+n.expires.toUTCString()),n.httpOnly&&a.push("HttpOnly"),n.secure&&a.push("Secure"),a.join("; ")},parse:function(e,t){t=t||{};var n={},s=e.split(/; */),a=t.decode||r;return s.forEach(function(e){var t=e.indexOf("=");if(!(0>t)){var r=e.substr(0,t).trim(),s=e.substr(++t,e.length).trim();if('"'==s[0]&&(s=s.slice(1,-1)),void 0==n[r])try{n[r]=a(s)}catch(i){n[r]=s}}}),n}},t=encodeURIComponent,r=decodeURIComponent;"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define("cookie-js/cookie",[],function(){return e}):window.cookiejs=e}(),function(e,t){"function"==typeof define&&define.amd?define("analytics",t):"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=t():e.analytics=t()}(this,function(){function e(e){var r=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return e=t(e),e.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(e,t,n){return t>0&&t+e.length!==n.length&&e.search(r)>-1&&":"!==n.charAt(t-2)&&("-"!==n.charAt(t+e.length)||"-"===n.charAt(t-1))&&n.charAt(t-1).search(/[^\s-]/)<0?e.toLowerCase():e.substr(1).search(/[A-Z]|\../)>-1?e:e.charAt(0).toUpperCase()+e.substr(1)})}function t(e){return e.replace(/^\s+|\s+$/g,"")}function r(e){return/[^@]+@[^@]+/.test(e)}function n(e){console.warn("[analytics] "+e)}function s(e){if("function"==typeof ga){var t={hitType:"event",eventCategory:d,eventAction:e.action};e.label&&(t.eventLabel=e.label),(e.value||0===e.value)&&(t.eventValue=e.value),e.nonInteraction===!0&&(t.nonInteraction=1),ga("send",t)}var r=["_trackEvent",d,e.action];e.label&&(r[3]=e.label),(e.value||0===e.value)&&(r[4]=e.value),e.nonInteraction===!0&&(r[5]=!0),_gaq.push(r)}function a(a,i){i=i||{};var o={},l=i.label,c=i.value,u=i.noninteraction||i.nonInteraction;return a?(r(a)&&(n("`action` arg looks like an email address, redacting."),a=m),o.action=e(a),l&&("string"!=typeof l?n("Expected `label` arg to be a String."):(r(l)&&(n("`label` arg looks like an email address, redacting."),l=m),o.label=t(l))),(c||0===c)&&("number"!=typeof c?n("Expected `value` arg to be a Number."):o.value=0|c),u&&("boolean"!=typeof u?n("Expected `noninteraction` arg to be a Boolean."):o.nonInteraction=u===!0),void s(o)):void n("Expected `action` arg.")}function i(e){return/^\/virtual\//.test(e)?e:(e=e.replace(/^[/]?/,"/"),"/virtual"+e)}function o(e){if("function"==typeof ga){var t={hitType:"pageview",page:e.virtualPagePath};ga("send",t)}var r=["_trackPageview",e.virtualPagePath];_gaq.push(r)}function l(e){if(!e)return void n("Expected `virtualPagePath` arg.");e=t(e);var r={};r.virtualPagePath=i(e),o(r)}function c(e){var t=["trackEvent",e.action];if(e.revenue){var r={revenue:e.revenue};t[2]=r}optimizely.push(t)}function u(e,r){r=r||{};var s={},a=r.valueInCents;return e?(s.action=t(e),a&&("number"==typeof a&&a%1===0?s.revenue=a:n("Expected `valueInCents` arg to be an integer.")),void c(s)):void n("Expected `action` arg.")}this._gaq||(this._gaq=[]),this.optimizely||(this.optimizely=[]);var d=location.hostname,m="REDACTED (Potential Email Address)";return{event:a,virtualPageview:l,conversionGoal:u}}),function(e){function t(t,n,s){return function(a){e.localStorage||console.error("Local storage must be supported for instant login.");var i=this,o={domain:location.hostname.split(".").slice(-2).join("."),path:"/",secure:"https:"===location.protocol,expires:new Date(Date.now()+6048e5)},l=/ref=((?:\w|-)+)/.exec(e.location.search),c=n.parse(document.cookie).webmakerReferral;l&&(l=l[1]),a=a||{},a.paths=a.paths||{},i.emitter=new t,i.host=a.host||"",i.paths=a.paths||{},i.paths.authenticate=a.paths.authenticate||"/authenticate",i.paths.create=a.paths.create||"/create",i.paths.verify=a.paths.verify||"/verify",i.paths.logout=a.paths.logout||"/logout",i.paths.checkUsername=a.paths.checkUsername||"/check-username",i.urls={authenticate:i.host+i.paths.authenticate,create:i.host+i.paths.create,verify:i.host+i.paths.verify,logout:i.host+i.paths.logout,checkUsername:i.host+i.paths.checkUsername},i.audience=a.audience||e.location.protocol+"//"+e.location.host,i.prefix=a.prefix||"webmaker-",i.timeout=a.timeout||10,i.localStorageKey=i.prefix+"login",i.csrfToken=a.csrfToken,i.withCredentials=a.withCredentials===!1?!1:!0,l&&c!==l&&(document.cookie=n.serialize("webmakerReferral",l,o),c=l),i.clearReferrerCookie=function(){var e=o;e.expires=new Date(Date.now()-1e4),document.cookie=n.serialize("webmakerReferral","expire",e)},i.handleNewUserUI=a.handleNewUserUI===!1?!1:!0,i.analytics={},i.analytics.webmakerNewUserCancelled=function(){s.event("Webmaker New User Cancelled")},i.modal={},i.modal.element=document.getElementById("webmaker-login-new-user"),i.modal.dismissSelector="[data-dismiss]",i.modal.createSelector=".create-user",i.modal.createBtnOnClick=function(){},i.modal.checkUsernameOnChange=function(){var e=i.modal.element.querySelector(".username-taken-error"),t=i.modal.element.querySelector(".username-invalid-error"),r=i.modal.element.querySelector(".username-required-error"),n=i.modal.element.querySelector(".username-group"),s=this.value;return s?void i.checkUsername(s,function(s,a){s&&"Username taken"===a?(n.classList.add("has-error"),n.classList.remove("has-success"),e.classList.remove("hidden"),r.classList.add("hidden"),t.classList.add("hidden")):s&&"Username invalid"===a?(n.classList.add("has-error"),n.classList.remove("has-success"),t.classList.remove("hidden"),e.classList.add("hidden"),r.classList.add("hidden")):(n.classList.remove("has-error"),n.classList.add("has-success"),e.classList.add("hidden"),r.classList.add("hidden"),t.classList.add("hidden"))}):(n.classList.remove("has-success"),n.classList.add("has-error"),e.classList.add("hidden"),r.classList.remove("hidden"),void t.classList.add("hidden"))},i.modal.setup=function(e){var t=i.modal.element.querySelector(i.modal.createSelector),r=i.modal.element.querySelectorAll(i.modal.dismissSelector),n=i.modal.element.querySelector(".username-group"),s=i.modal.element.querySelector(".agree-group"),a=i.modal.element.querySelector(".username-taken-error"),o=i.modal.element.querySelector(".username-required-error"),l=i.modal.element.querySelector(".username-invalid-error"),c=i.modal.element.querySelector(".agree-error"),u=i.modal.element.querySelector('[name="username"]'),d=i.modal.element.querySelector('[name="agreeToTerms"]'),m=i.modal.element.querySelector('[name="mailingList"]'),h=i.modal.element.querySelector("[name=supportedLocales]");t.removeEventListener("click",i.modal.createBtnOnClick,!1),u.addEventListener("change",i.modal.checkUsernameOnChange,!1),i.modal.createBtnOnClick=function(){var t=!1;d.checked||(s.classList.add("has-error"),c.classList.remove("hidden"),t=!0),u.value||(n.classList.remove("has-success"),n.classList.add("has-error"),a.classList.add("hidden"),o.classList.remove("hidden"),l.classList.add("hidden"),t=!0),t||i.checkUsername(u.value,function(t,r){t&&"Username taken"===r?(n.classList.add("has-error"),n.classList.remove("has-success"),a.classList.remove("hidden"),o.classList.add("hidden"),l.classList.add("hidden")):t&&"Username invalid"===r?(n.classList.add("has-error"),n.classList.remove("has-success"),l.classList.remove("hidden"),a.classList.add("hidden"),o.classList.add("hidden")):i.createUser({assertion:e,user:{username:u.value,mailingList:m.checked,prefLocale:h.value}},function(e){return e?void console.error(e):(a.classList.add("hidden"),o.classList.add("hidden"),l.classList.add("hidden"),c.classList.add("hidden"),n.classList.remove("has-error"),n.classList.remove("has-success"),s.classList.remove("has-error"),void i.modal.close())})})};for(var f=0;f<r.length;f++)r[f].removeEventListener("click",i.modal.close,!1),r[f].addEventListener("click",i.modal.close,!1);t.addEventListener("click",i.modal.createBtnOnClick,!1)},i.modal.open=function(){i.modal.element.classList.add("in"),i.modal.element.style.display="block",i.modal.element.setAttribute("aria-hidden",!1)},i.modal.close=function(e){e&&i.analytics.webmakerNewUserCancelled(),i.modal.element.classList.remove("in"),i.modal.element.style.display="none",i.modal.element.setAttribute("aria-hidden",!0)},i.on=function(e,t){i.emitter.addListener(e,t)},i.off=function(e,t){i.emitter.removeListener(e,t)},i.checkUsername=function(e,t){if(!r.test(e))return t(!0,"Username invalid");var n=new XMLHttpRequest,s=JSON.stringify({username:e});n.open("POST",i.urls.checkUsername,!0),n.withCredentials=i.withCredentials,n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("X-CSRF-Token",i.csrfToken),n.onreadystatechange=function(){if(4===n.readyState&&200===n.status){var e=JSON.parse(n.responseText);e.exists?t(!0,"Username taken"):t(!1,"Username not taken")}else 4===n.readyState&&n.status&&(n.status>=400||n.status<200)?(i.emitter.emit("error",n.responseText),t(!1,"Error checking username")):4===n.readyState&&(i.emitter.emit("error","Looks like "+i.urls.checkUsername+" is not responding..."),t(!1,"Error checking username"))},n.send(s)},i.createUser=function(e,t){e.user.referrer=c;var r=new XMLHttpRequest,n=JSON.stringify({assertion:e.assertion,audience:i.audience,user:e.user});t=t||function(){},r.open("POST",i.urls.create,!0),r.withCredentials=i.withCredentials,r.setRequestHeader("Content-type","application/json"),r.setRequestHeader("X-CSRF-Token",i.csrfToken),r.onreadystatechange=function(){if(4===r.readyState&&200===r.status){var e=JSON.parse(r.responseText);e.user?(i.storage.set(e.user),i.emitter.emit("login",e.user,"user created"),s.event("Webmaker New User Created",{nonInteraction:!0}),s.conversionGoal("WebmakerNewUserCreated"),i.clearReferrerCookie(),t(null,e.user)):(i.emitter.emit("error",r.responseText),t(r.responseText))}else 4===r.readyState&&r.status&&(r.status>=400||r.status<200)?(i.emitter.emit("error",r.responseText),t(r.responseText)):4===r.readyState&&(i.emitter.emit("error","Looks like "+i.urls.create+" is not responding..."),t(r.responseText))},r.send(n)},i.verify=function(){i.storage.get()&&i.emitter.emit("login",i.storage.get(),"restored");var e=i.storage.get("email"),t=new XMLHttpRequest;t.open("POST",i.urls.verify,!0),t.withCredentials=i.withCredentials,t.setRequestHeader("Content-type","application/json"),t.setRequestHeader("X-CSRF-Token",i.csrfToken),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var r=JSON.parse(t.responseText);e&&r.email===e?(i.emitter.emit("login",r.user,"verified"),i.storage.set(r.user)):r.user?(i.emitter.emit("login",r.user,"email mismatch"),i.storage.set(r.user)):(i.emitter.emit("logout"),i.storage.clear())}else 4===t.readyState&&t.status&&(t.status>=400||t.status<200)?i.emitter.emit("error",t.responseText):4===t.readyState&&i.emitter.emit("error","Looks like "+i.urls.verify+" is not responding...")},t.send()},i.login=function(){return e.navigator.id?(s.event("Webmaker Login Clicked"),e.removeEventListener("focus",i.verify,!1),void e.navigator.id.get(function(t){if(!t)return i.emitter.emit("error","No assertion was received"),void s.event("Persona Login Cancelled");s.event("Persona Login Succeeded");var r={referrer:c},n=new XMLHttpRequest,a=JSON.stringify({audience:i.audience,assertion:t,user:r});if(i.timeout)var o=setTimeout(function(){n.abort(),i.emitter.emit("error","The request for a token timed out after "+i.timeout+" seconds")},1e3*i.timeout);n.open("POST",i.urls.authenticate,!0),n.withCredentials=i.withCredentials,n.setRequestHeader("Content-type","application/json"),n.setRequestHeader("X-CSRF-Token",i.csrfToken),n.onreadystatechange=function(){if(i.timeout&&o&&clearTimeout(o),4===n.readyState&&200===n.status){var r=JSON.parse(n.responseText);r.error&&i.emitter.emit("error",r.error),r.user&&(i.storage.set(r.user),i.emitter.emit("login",r.user),s.event("Webmaker Login Succeeded"),i.clearReferrerCookie(),e.addEventListener("focus",i.verify,!1)),r.email&&!r.user&&(i.emitter.emit("newuser",t,r.email),s.event("Webmaker New User Started"),i.handleNewUserUI&&(i.modal.setup(t,r.email),i.modal.open())),r.err&&i.emitter.emit("error",r.err)}else 4===n.readyState&&n.status&&(n.status>=400||n.status<200)?i.emitter.emit("error",n.responseText):4===n.readyState&&i.emitter.emit("error","Looks like "+i.urls.authenticate+" is not responding...")},n.send(a)},{backgroundColor:"#E3EAEE",privacyPolicy:"https://webmaker.org/privacy",siteLogo:"https://stuff.webmaker.org/persona-assets/logo-webmaker.png",siteName:"Mozilla Webmaker",termsOfService:"https://webmaker.org/terms"})):void console.error("No persona found. Did you include include.js?")},i.logout=function(){s.event("Webmaker Logout Clicked"),e.removeEventListener("focus",i.verify,!1);var t=new XMLHttpRequest;t.open("POST",i.urls.logout,!0),t.withCredentials=i.withCredentials,t.setRequestHeader("X-CSRF-Token",i.csrfToken),t.onreadystatechange=function(){4===t.readyState&&200===t.status?(i.emitter.emit("logout"),i.storage.clear(),e.addEventListener("focus",i.verify,!1)):4===t.readyState&&t.status&&(t.status>=400||t.status<200)?i.emitter.emit("error",t.responseText):4===t.readyState&&i.emitter.emit("error","Looks like "+i.urls.logout+" is not responding...")},t.send(null)},i.storage={get:function(e){var t=JSON.parse(localStorage.getItem(i.localStorageKey));if(t)return e?t[e]:t},set:function(e){var t=JSON.parse(localStorage.getItem(i.localStorageKey))||{};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);localStorage.setItem(i.localStorageKey,JSON.stringify(t))},clear:function(){delete localStorage[i.localStorageKey]}}}}var r=/^[abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\-]{1,20}$/;if("function"==typeof define&&define.amd)define("webmaker-auth-client",["eventEmitter/EventEmitter","cookie-js/cookie","analytics"],t);else if("object"==typeof module&&module.exports){var n=require("cookie"),s=require("events").EventEmitter,a=require("webmaker-analytics");module.exports=t(s,n,a)}else e.WebmakerAuthClient=t(e.EventEmitter,e.cookiejs,e.analytics)}(window);